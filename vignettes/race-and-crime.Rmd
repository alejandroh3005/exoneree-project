---
title: "Crime and Race"
author: "Alejandro Hernandez"
date: "`r Sys.Date()`"
output:
  pdf_document: default
subtitle: Exoneree Project
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = paste(head(unlist(strsplit(getwd(), "/")), -1),
                                      collapse = "/"))
library(tidyverse)
# library(gridExtra)
library(gtsummary)
library(gt)
```

```{r data-loading}
rm(list = ls()) # clear workspace
# load data
exonerees <- read.csv("data/exonerees1989-may2024.csv")


# correct Crime Category to be a factor
crime_levels <- c("Violent felony", "Misdemeanor", "Nonviolent felony", 
                  "Misconduct")
exonerees$Crime.Category <- factor(exonerees$Crime.Category, 
                                   levels = crime_levels)

# correct Age Group variables to be factors
age_levels = c("0 - 17", "18 - 29", "30 - 39", "40 - 49", "50 - 64", "65 - 100")
exonerees$Age.Group.at.Crime <- factor(exonerees$Age.Group.at.Crime, 
                                       levels = age_levels)
exonerees$Age.Group.at.Conviction <- factor(exonerees$Age.Group.at.Conviction, 
                                            levels = age_levels)
exonerees$Age.Group.at.Release <- factor(exonerees$Age.Group.at.Release, 
                                         levels = age_levels)
exonerees$Age.Group.at.Exoneration <- factor(exonerees$Age.Group.at.Exoneration,
                                             levels = age_levels)

# correct Race to be a factor
race_levels <- c("Black", "White", "Hispanic", "Native American", "Asian", 
                 "Other")
exonerees$Race <- factor(exonerees$Race, levels = race_levels)

# correct Sex to be a factor
exonerees$Sex <- as.factor(exonerees$Sex)

# correct binary tags to also be factors
tag_vars <- c("F.MFE","FC","ILD","P.FA","DNA","MWID","OM","CV","IO","SA","CIU",
              "NC","P","H","JV","CDC","F","JI","M","CSH","SBS","A","FED","PH",
              "BM")
exonerees <- exonerees %>% mutate_at(tag_vars, as.factor)
```

```{r include=FALSE}
# make sure everything looks good
summary(exonerees)
dim(exonerees)
```

# Distribution Tables

Create a tables of distributions across types of offense.   

```{r}
# build summary tables
gt_table1 <- exonerees %>% select(Crime.Category, 
                                  Sex, 
                                  Race, 
                                  Age.Group.at.Conviction) %>%
  gtsummary::tbl_summary(
    by = Crime.Category,
    statistic = list(
      all_categorical() ~ "{n} ({p}%)")) %>%   # count (percentage) for factors
  add_overall() %>%
  bold_labels() %>%     # make the labels bold
  modify_header(label ~ "**Variable**") %>%  # Customize the header
  modify_spanning_header(c(stat_1, stat_2) ~ "**Crime Category**") %>%
  as_gt()

gt_table2 <- exonerees %>% select(Crime.Category, 
                                  Age.at.Crime, 
                                  Age.at.Conviction, 
                                  Age.at.Release, 
                                  Age.at.Exoneration) %>%
  gtsummary::tbl_summary(
    by = Crime.Category,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})")) %>% # mean (IQR) for continuous
  add_overall() %>%
  bold_labels() %>%     # make the labels bold
  modify_header(label ~ "**Variable**") %>%  # Customize the header
  modify_spanning_header(c(stat_1, stat_2) ~ "**Crime Category**") %>%
  as_gt()


gt_table3 <- exonerees %>% select(Crime.Category, 
                                  Months.Incarcerated, 
                                  Months.Convicted, 
                                  Years.Incarcerated, 
                                  Years.Convicted) %>%
  gtsummary::tbl_summary(
    by = Crime.Category,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})")) %>%
  add_overall() %>%
  bold_labels() %>%     # make the labels bold
  modify_header(label ~ "**Variable**") %>%  # Customize the header
  modify_spanning_header(c(stat_1, stat_2) ~ "**Crime Category**") %>%
  as_gt()

# save the gt table as a PNG file
gt::gtsave(gt_table1, filename = "images/crime-categories.png", path = getwd())
gtsave(gt_table2, filename = "images/crime-ages.png", path = getwd())
gtsave(gt_table3, filename = "images/crime-time.png", path = getwd())
```

# Distribution Graphs

First, we want to verify that, when interested in time spent wrongly imprisoned, the categories of Sex, Race, and Age are distinct groups. As we do so, we will describe how the distribution of time spent wrongly imprisoned for one group compares to its counterpart(s).

Note that time is measured here in months.

```{r distribution-of-time-spent-imprisoned}
gg_time_imprisoned <- exonerees %>%
  filter(!is.na(Months.Incarcerated)) %>%
  ggplot() +
  # jitter points (these must be overlayed by the horizontal line)
  geom_jitter(aes(y = Months.Incarcerated, x = ""), 
              width = 0.4, color = "aliceblue") +

  # marker at 1 year
  geom_hline(yintercept = 12, color = "red") +
  # time spent wrongfully imprisoned
  geom_violin(aes(y = Months.Incarcerated, x = "")) +
  geom_boxplot(aes(y = Months.Incarcerated, x = ""), alpha = 0.5) +
  
  # plot specifics
  ylab("Months spent wrongfully imprisoned") + xlab("") +
  scale_y_continuous(breaks = seq(0, 400, 120)) +
  theme_bw()

gg_time_imprisoned
```


```{r verify-covars}
gg_time_imprisoned + facet_wrap(vars(Sex))
gg_time_imprisoned + facet_wrap(vars(Race))
gg_time_imprisoned + facet_wrap(vars(Age.Group.at.Conviction))
```


**End of document.**